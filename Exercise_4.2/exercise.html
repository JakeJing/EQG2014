<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>Exercise in phylogenetic comparative methods</title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1265.21">
  <style type="text/css">
    body {background-color: #ccffff}
    p.p2 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times}
    p.p3 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times; min-height: 14.0px}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times; color: #0000ee}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Courier}
    li.li5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times}
    li.li7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Courier}
    span.s1 {font: 24.0px Courier}
    span.s2 {font: 12.0px Courier}
    span.s3 {text-decoration: underline ; color: #0000ee}
    span.s4 {font: 12.0px Courier; color: #0000ee}
    span.s5 {text-decoration: underline}
    table.t1 {background-color: #ffffff}
    td.td1 {width: 18.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td2 {width: 346.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td3 {width: 87.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td4 {width: 217.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td5 {width: 224.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td6 {width: 116.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td7 {width: 94.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td8 {width: 173.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td9 {width: 181.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td10 {width: 109.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td11 {width: 188.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td12 {width: 152.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    td.td13 {width: 73.0px; margin: 0.5px 0.5px 0.5px 0.5px; padding: 1.0px 1.0px 1.0px 1.0px}
    ol.ol1 {list-style-type: decimal}
    ul.ul1 {list-style-type: disc}
  </style>
</head>
<body>
<h1 style="margin: 0.0px 0.0px 16.1px 0.0px; text-align: center; font: 24.0px Times"><b>R exercise on the contrasts method using </b><span class="s1"><b>APE</b></span></h1>
<p class="p2">This R exercise uses the <span class="s2">pic</span> (phylogenetically independent contrasts) function from Emanual Paradis's package <span class="s2">APE</span>. It also uses a few other functions from that package.</p>
<p class="p3"><br></p>
<h2 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 18.0px Times"><b>A supplementary reading or two</b></h2>
<p class="p2">The folks at the R Hackathon on Comparative Methods in R have a <a href="http://informatics.nescent.org/wiki/R_Hackathon_1/Phylogenetic_Independent_Contrasts"><span class="s3">simple guide to using the </span><span class="s4">pic</span><span class="s3"> function to compute phylogenetic contrasts</span></a>. It is parallel to the material here and will be a helpful supplement to this exercise. There is also a broader <a href="http://www2.hawaii.edu/~mbutler/Rquickstart/Rcomparative.pdf"><span class="s3">Comparative Methods and Data Analysis in R </span></a>by Marguerite Butler, Brian O'Meara, and Jason Pienaar which has more material on using <span class="s2">APE</span> and R for comparative methods.</p>
<p class="p3"><br></p>
<h2 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 18.0px Times"><b>The example's data</b></h2>
<p class="p2">The data used in this example will be from a recent paper:</p>
<table cellspacing="0" cellpadding="0">
  <tbody>
    <tr>
      <td valign="middle" class="td1">
        <p class="p5">      </p>
      </td>
      <td valign="middle" class="td2">
        <p class="p5">Alexander Riek and Fritz Geiser. 2013. Allometry of thermal variables</p>
        <p class="p5">in mammals: consequences of body size and phylogeny.</p>
        <p class="p5"><i>Biological Reviews</i>, Volume 88, Issue 3, pages 564-572 (August 2013).<span class="Apple-converted-space"> </span></p>
        <p class="p6"><span class="s5"><a href="http://onlinelibrary.wiley.com/doi/10.1111/brv.12016/full">DOI: 10.1111/brv.12016</a></span></p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">The data provided is a phylogeny of 204 mammal species, which they derived from a published mammalian supertree. Here it is in Newick format in a file <a href="file:///Users/joe/courses/quantgen/2014/comparative/mammals.tre"><span class="s4">mammals.tre</span></a>. I will tell you below how to read this tree into APE. The species range widely over mammals, including monotremes and marsupials. In the tree the species <i>Ovis ammon</i>, the argali or Asian mountain sheep, seems to be present instead of the mouflon or domestic sheep <i>Ovis orientalis aries</i>. I did not have time to untangle this, so I have changed the species name in the tree to the latter. If you want to know what any of the species are, I suggest typing its name into a browser.</p>
<p class="p2">The data is in a file <a href="file:///Users/joe/courses/quantgen/2014/comparative/mammals.dat"><span class="s4">mammals.dat</span></a> and shows 5 variables in 204 species, with some data missing and represented by NA. This is a 204 x 8 data frame (the row names being the species names). We will see how to read this data into APE. The 5 columns are:</p>
<ol class="ol1">
  <li class="li5">SZ: Body mass (in grams). Note that for large mammals these numbers can get very large. They are very asymmetrically distributed.</li>
  <li class="li5">BT: Body temperature (in degrees Celsius)</li>
  <li class="li5">TLC: Lower critical temperature (in degrees Celsius)</li>
  <li class="li5">TUC: Upper critical temperature (in degrees Celsius)</li>
  <li class="li5">TNZ: Breadth of the thermo-neutral zone (in degrees Celsius)</li>
</ol>
<p class="p5">We will use the first three of these, since they are available in all 304 species. It would be possible to reduce the phylogeny to those species on which all six variables are present and do an analysis on all 5 variables.</p>
<p class="p3"><br></p>
<h2 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 18.0px Times"><b>Starting APE</b></h2>
<p class="p2">Emanuel Paradis' phylogeny package APE is widely available and can be loaded by doing the command</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td3">
        <p class="p7">library(ape)</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">or else the command</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td3">
        <p class="p7">require(ape)</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">There will probably be a warning message that <span class="s2">APE</span> has been compiled with an earlier version of <span class="s2">R</span>. This can generally be ignored.</p>
<p class="p2">If this doesn't work, you will find APE at the CRAN archive <a href="http://cran.r-project.org/web/packages/ape/index.html"><span class="s3">here</span></a>.</p>
<p class="p3"><br></p>
<h2 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 18.0px Times"><b>Loading the tree</b></h2>
<p class="p2">An tree object of class phylo can be created from a text file in Newick tree format by the APE command</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td4">
        <p class="p7">tr &lt;- read.tree("mammals.tre")</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p3"><br></p>
<h2 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 18.0px Times"><b>Reading in the data</b></h2>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td5">
        <p class="p7">dd &lt;- read.table("mammals.dat")</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">This reads in the data frame and calls it <span class="s2">dd</span>. The species names and variable names are automatically visible to R.</p>
<p class="p3"><br></p>
<h2 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 18.0px Times"><b>Making vectors of the characters</b></h2>
<p class="p2">Vectors containing the values of the characters are easily made, using the character names:</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td3">
        <p class="p7">x &lt;- dd$SZ;</p>
        <p class="p7">y &lt;- dd$BT;</p>
        <p class="p7">z &lt;- dd$TLC;</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">If we look at the histogram of <span class="s2">x</span>, the body size, we will find that it is bizarrely asymmetric, with most species near 0, and a few dominating the variation. It is more sensible to work with the logarithm of body size. That could be obtained as</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td6">
        <p class="p7">xl &lt;- log(dd$SZ)</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">or, more simply,</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td7">
        <p class="p7">xl &lt;- log(x);</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p3"><br></p>
<h2 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 18.0px Times"><b>Regressions of species</b></h2>
<p class="p2">If we were to ignore phylogeny, we can plot pairs of variables against each other, using commands like <span class="s2">plot(y,tl)</span>. What do you see if you do that? Do these seem to be significant? Use regression commands such as</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td8">
        <p class="p7">plot(y,xl);</p>
        <p class="p7">abline(lm(y ~ xl)$coef);</p>
        <p class="p7">summary(lm(y ~ xl));</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">(execute these commands one at a time to see most clearly what is going on, and please notice that the tilde in the second and third commands is not a minus sign). The first does the plot, the second adds a line of best fit, and the third prints out a summary of the fit of <span class="s2">y</span> to <span class="s2">xl</span> including a statistical test of nonzero slope.</p>
<p class="p2">Alternatively we could have computed covariances or correlations, or obtained principal components from a matrix whose columns were the variables. We will see how to do these below.</p>
<p class="p3"><br></p>
<h2 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 18.0px Times"><b>Phylogenetic comparative methods</b></h2>
<p class="p2">Of course, this is not correct. The points are not independent and identically distributed (why?). To correct for the evolutionary relatedness of the points, we can use the phylogenetically independent contrasts. We will use the function <span class="s2">pic</span> from <span class="s2">APE</span>.</p>
<p class="p2">There are two steps we will need for each variable. For each variable, we will have <span class="s2">pic</span> compute a vector of contrasts. To do that we must make sure that the species names on the tree are associated with the appropriate rows of the data matrix. So for variable <span class="s2">y</span>, we use the command</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td9">
        <p class="p7">names(y) &lt;- row.names(dd)</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2"><i>and you should make sure to do this separately for each of your variables</i>.</p>
<p class="p2">We are now ready to make up the contrasts vectors. For <span class="s2">y</span>, we make a vector of contrasts using</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td10">
        <p class="p7">yc &lt;- pic(y,tr)</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">We don't have to associate names of species with the contrasts; each can contain information from more than one species.</p>
<p class="p2">Now we can do plots, lines of best fit, and tests using the contrasts instead of the values for the species:</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td7">
        <p class="p7">plot(xlc,yc);</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">and</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td9">
        <p class="p7">abline(lm(yc ~ xlc - 1));</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">and</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td11">
        <p class="p7">summary(lm(yc ~ xlc - 1));</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">(The -1 signals the linear model to force the regression through the origin). we might want to do this for all possible pairs of variables. There is the issue of which is the Y axis, and which is the X axis in the regression. Are there cases where the regression seemed to be significant, but is not significant when the contrasts are used? Are there cases where a regression is not significant in the species values, but is when you use the contrasts?</p>
<p class="p3"><br></p>
<h2 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 18.0px Times"><b>Multivariate phylogenetic comparative methods</b></h2>
<p class="p2">It will probably be better to take a more fully multivariate approach to covariation of characters. If we make up a matrix whose columns are the contrast values, we can look at the covariance matrix, and from it compute correlations, principal components, etc.</p>
<p class="p2">To make up a matrix with the contrasts of all characters in it, you can do</p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="middle" class="td12">
        <p class="p7">X &lt;- cbind(xlc,yc,zc)</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2">Now it will be possible to do multivariate statistics on X. As the elements of its columns are contrasts, they are independent of each other if the process on the tree is Brownian Motion. They are properly scaled (by the contrasts calculation used in <span class="s2">pic</span>) to be independent and identically distributed variates. They continue to show the covariation among characters, so we can use them with ordinary multivariate statistics available in R.</p>
<p class="p2">But there is a complication. The original variables had nonzero expectations, but (under the assumptions) the contrasts have expectation zero. So in doing regressions or computing covariances, you should force the expectations to zero. That means that</p>
<ul class="ul1">
  <li class="li5">All regressions should be through the origin. A typical regression calculation (say column 1 of X, which is <span class="s2">xlc</span> on column 2, which is <span class="s2">y</span>) would be</li>
  <table cellspacing="0" cellpadding="0" class="t1">
    <tbody>
      <tr>
        <td valign="middle" class="td6">
          <li class="li7">lm(xlc ~ yc - 1)</li>
          <li class="li5"></li>
        </td>
      </tr>
    </tbody>
  </table>
  <li class="li5">where the "-1" indicates that the regression should be forced through the origin.</li>
  <li class="li5">The covariances of the columns of X can be estimated by taking the sums of products by the matrix calculations:</li>
  <table cellspacing="0" cellpadding="0" class="t1">
    <tbody>
      <tr>
        <td valign="middle" class="td10">
          <li class="li7">S &lt;- t(X) %*% X</li>
          <li class="li5"></li>
        </td>
      </tr>
    </tbody>
  </table>
  <li class="li5">So S is the sum of squares (or sum of products) matrix. We don't need any terms subtracting out the squares (or products) of means. If we divide the sum-of-squares matrix S by the number of independent contrasts (202), we get the estimate of the covariance matrix of evolutionary changes in the traits:</li>
  <table cellspacing="0" cellpadding="0" class="t1">
    <tbody>
      <tr>
        <td valign="middle" class="td13">
          <li class="li7">V &lt;- S/202</li>
          <li class="li5"></li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
<p class="p3"><br></p>
<h2 style="margin: 0.0px 0.0px 14.9px 0.0px; font: 18.0px Times"><b>Things you might do</b></h2>
<p class="p3"><br></p>
<ol class="ol1">
  <li class="li5">Use <span class="s2">pic</span> to compute the vectors of contrasts. Also assemble these into a matrix X. Compute the covariance matrix V.</li>
  <li class="li5">Do regressions (through the origin!) of variables on each other. Are there cases where the original "tips" regression was significant, but the contrasts regression isn't? Cases with the original regression is not significant, but the regression of contrast is?</li>
  <li class="li5">Take the covariance matrix V and use the <span class="s2">eigen</span> function to find its principal components. How does the first principal component compare with the first PC that you would get if you used the original (tips) variables and computed a covariance matrix using the <span class="s2">cov</span> function?</li>
</ol>
</body>
</html>
